#!/usr/bin/make -f
#
# Build Debian package using https://github.com/spotify/dh-virtualenv

export DH_VIRTUALENV_INSTALL_ROOT=/opt/venvs
NODEENV_VERSION=1.3.1
EXTRA_REQUIREMENTS=--upgrade-pip --preinstall "setuptools>=17.1" --preinstall "wheel"

ifeq (1,$(shell grep -iscm1 xenial /etc/os-release))
    # On Xenial, install "python3.6 python3.6-tk" from Deadsnakes PPA
    SNAKE=/usr/bin/python3.6
else
    SNAKE=/usr/bin/python3
endif

PACKAGE=$(shell dh_listpackages)
VERSION=$(shell parsechangelog | grep ^Version: | sed -re 's/[^0-9]+([^-]+).*/\1/')
DH_VENV_ARGS=--setuptools --builtin-venv --python $(SNAKE) $(EXTRA_REQUIREMENTS)
           # --extra-pip-arg "--no-binary=psycopg2" \
           # -v
DH_VENV_DIR=debian/$(PACKAGE)$(DH_VIRTUALENV_INSTALL_ROOT)/$(PACKAGE)


%:
	dh $@ --with python-virtualenv

.PHONY: override_dh_virtualenv override_dh_strip override_dh_shlibdeps

override_dh_virtualenv:
	dh_virtualenv $(DH_VENV_ARGS)
	$(DH_VENV_DIR)/bin/python $(DH_VENV_DIR)/bin/pip install nodeenv==$(NODEENV_VERSION)
	$(DH_VENV_DIR)/bin/nodeenv -C '' -p -n system
	. $(DH_VENV_DIR)/bin/activate

override_dh_virtualenv:
	dh_virtualenv --python python3

override_dh_strip:
	dh_strip --exclude=cffi --exclude=_imaging --exclude=libtiff

override_dh_shlibdeps:
	dh_shlibdeps -X/x86/ -X/numpy/ -X/cv2/ -X/PIL/
